
@using CiscaLab.ViewModels
@model CiscaLab.ViewModels.ReporteFinalViewModel

@{
    ViewData["Title"] = "Reporte Final";
}

<div class="encabezado-laboratorio">
    <div style="display: flex; align-items: center;">
        <img src="/images/logo-laboratorio.png" alt="Logo del laboratorio" style="height: 60px; margin-right: 15px;" />
        <div>
            <h1 style="margin: 0; font-size: 20px;">Laboratorio Clínico CiscaLab</h1>
            <p style="margin: 0; font-size: 12px;">
                Entrada a la López Arellano, Choloma, Cortés · Tel: (504) 9999-9999 · Email: contacto@ciscalab.hn
            </p>
        </div>
    </div>


    
    
    <div class="mb-3">
        <strong>Paciente:</strong> @Model.NombrePaciente <br />
        <strong>Edad:</strong> @Model.Edad años <br />
        <strong>Sexo:</strong> @Model.Sexo <br />
        <strong>Fecha:</strong> @Model.Fecha.ToShortDateString()
    </div>

    <hr />

</div>




<div class="marca-agua">
    <img src="/images/logo-laboratorio.png" alt="Marca de agua" />
</div>



@{
    int index = 0;
}



@foreach (var examen in Model.Examenes.Where(e => !e.ExcluirParaImprimir))
{
    var claseSalto = examen.ImprimirEnUnaPagina ? "examen-pagina" : "examen-seccion";

    <div class="@claseSalto">

        <h4 class="mt-4">@examen.NombreExamen</h4>
        <table class="table table-borderless">
            <thead>
                <tr>
                    <th>Parámetro</th>
                    <th>Resultado</th>
                    <th>Unidad</th>
                    <th>Valores de Referencia</th>
                    <th>Observaciones</th>
                </tr>
            </thead>
            <tbody>
               
            @foreach (var detalle in examen.ResultadosDetalle)
            {
                var normales = detalle.ExamenDetalle.ExamenesDetalleValoresNormales.FirstOrDefault();
                string valoresNormales = "";
                bool fueraDeRango = false;
                string indicador = "";

        if (normales != null)
        {
            decimal? resultadoNum = detalle.ValorResultadoNumero;

            if (Model.Sexo == "Masculino")
            {
                if (normales?.VNInferiorHombre != null && normales?.VNSuperiorHombre != null)
                {
                    valoresNormales = $"{normales.VNInferiorHombre} - {normales.VNSuperiorHombre}";
                }

                if (resultadoNum.HasValue)
                {
                    if (resultadoNum.Value < normales?.VNInferiorHombre) { fueraDeRango = true; indicador = "↓"; }
                    if (resultadoNum.Value > normales?.VNSuperiorHombre) { fueraDeRango = true; indicador = "↑"; }
                }

            }
            else if (Model.Sexo == "Femenino")
            {
                if (normales?.VNInferiorMujer != null && normales?.VNSuperiorMujer != null)
                {
                    valoresNormales = $"{normales.VNInferiorMujer} - {normales.VNSuperiorMujer}";
                }

                if (resultadoNum.HasValue)
                {
                     if (resultadoNum.Value < normales?.VNInferiorMujer) { fueraDeRango = true; indicador = "↓"; }
                     if (resultadoNum.Value > normales?.VNSuperiorMujer) { fueraDeRango = true; indicador = "↑"; }
                }

            }
                        else if (Model.Edad < 12) // ejemplo para niños
                        {
                            valoresNormales = $"{normales.VNInferiorNino} - {normales.VNSuperiorNino}";
                            if (resultadoNum.HasValue)
                            {
                                if (resultadoNum.Value < normales.VNInferiorNino) { fueraDeRango = true; indicador = "↓"; }
                                if (resultadoNum.Value > normales.VNSuperiorNino) { fueraDeRango = true; indicador = "↑"; }
                            }

                        }
                        else if (normales.VNUnico > 0)
                        {
                            valoresNormales = normales.VNUnico.ToString();
                            if (resultadoNum.HasValue && resultadoNum.Value != normales?.VNUnico)
                            {
                                fueraDeRango = true;
                                indicador = resultadoNum.Value > normales?.VNUnico ? "↑" : "↓";

                            }
                        }
                    }


                    <tr class="@(fueraDeRango ? "table-danger font-weight-bold" : "")">
                    <td>@detalle.ExamenDetalle.NombreValor</td>
                    <td>
                        @{
                            string resultado = "";

                            if (!string.IsNullOrWhiteSpace(detalle.ValorResultadoTexto))
                            {
                                resultado = detalle.ValorResultadoTexto;
                            }
                            else if (detalle.ValorResultadoNumero.HasValue)
                            {
                                resultado = detalle.ValorResultadoNumero.Value.ToString("0.##");
                            }
                            else if (detalle.ValorResultadoPosNeg.HasValue)
                            {
                                resultado = detalle.ValorResultadoPosNeg.Value ? "Positivo" : "Negativo";
                            }

                        }
                        @resultado @indicador

                    </td>
                    <td>@detalle.ExamenDetalle.UnidadMedida?.NombreUnidadMedida</td>
                     <td>@valoresNormales</td>
                    <td>@detalle.Observaciones</td>
                </tr>
            }

            <tr>
                <td colspan="5" class="text-right">
                    <em>Método: @examen.Metodo?.NombreMetodo</em>
                </td>
            </tr>

        </tbody>
    </table>
    </div>
    index++;
}


<style>
    @@media print {

        @@page {
        margin: 20mm;
    }

    /* Pie de página fijo */
    .footer-reporte {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        font-size: 10px;
        text-align: center;
        border-top: 1px solid #000;
        padding-top: 4px;
    }

    /* Número de página automático */
    .page-number:before {
        content: "Página " counter(page);
    }

    /* Fecha y hora de impresión */
    .print-date:before {
        content: "Impreso el: " attr(data-fecha);
    }

    /* Encabezado fijo en todas las páginas */
    .encabezado-laboratorio

    {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: white;
        padding: 8px 20px;
        border-bottom: 1px solid #000; /* línea divisoria */
        z-index: 1000;
        page-break-after: avoid;
        page-break-before: avoid;
    }

    .encabezado-laboratorio h1 {
        margin: 0;
        font-size: 20px;
    }

    .encabezado-laboratorio p {
        margin: 0;
        font-size: 12px;
    }

    .encabezado-laboratorio .mb-3 {
        margin-top: 6px;
        margin-bottom: 6px;
        line-height: 1.2;
    }

    /* Espacio para que el contenido no se solape con el encabezado */
    .examen-pagina {
        page-break-after: always;
        padding-top: 160px; /* ajusta según el alto real del encabezado */
    }

    .examen-seccion {
        page-break-inside: avoid;
        padding-top: 160px;
    }

    /* Ajustes generales */
    body {
        margin: 0;
        font-size: 11px;
        line-height: 1;
    }

    h2, h4 {
        margin-top: 8px;
        margin-bottom: 4px;
    }

    table td, table th {
        padding: 1px 4px;
        line-height: 1;
    }

    button, a {
        display: none !important;
    }

    /* En impresión, resaltar fuera de rango en negrita y con borde */
    .fuera-rango {
        font-weight: bold;
        border: 2px solid black;
        color: black !important;
    }

    .indicador {
        font-weight: bold;
    }

    }

    /* En pantalla, resaltar con rojo */
    .fuera-rango {
        background-color: #f8d7da !important;
        color: #721c24 !important;
        font-weight: bold;
    }


</style>

<style>
    .marca-agua {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.06;
        z-index: 0;
        pointer-events: none;
    }

        .marca-agua img {
            width: 400px;
            height: auto;
        }

    @@media print {
        .marca-agua {
            display: block !important;
        }

        body {
            position: relative;
            z-index: 1;
        }
    }
</style>



<div class="mt-4">


    <style>
        @@media print {
            body {
                font-size: 11px;
                line-height: 1;
            }

            h2, h4 {
                margin-top: 8px;
                margin-bottom: 4px;
            }

            table {
                margin-bottom: 8px;
            }

                table td, table th {
                    padding: 1px 4px;
                    line-height: 1;
                }

            .mb-3 {
                margin-bottom: 4px !important;
            }

            .mt-4 {
                margin-top: 8px !important;
            }

            button, a {
                display: none !important;
            }
        }
    </style>
    
    <button onclick="window.print()" class="btn btn-outline-secondary">Imprimir</button>
    <a asp-action="SeleccionarOrdenTrabajo" class="btn btn-secondary">Volver</a>
</div>

<div class="footer-reporte">
    <span class="print-date" data-fecha="@DateTime.Now.ToString("dd/MM/yyyy HH:mm")"></span>
    @*&nbsp; | &nbsp;*@
    
</div>
